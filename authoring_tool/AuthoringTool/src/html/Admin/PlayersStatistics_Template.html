<!DOCTYPE html>
<html>
<head>
	<meta charset="ISO-8859-1">
	<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
	<script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.4.8/angular.min.js"></script>
	
	<script src="https://code.highcharts.com/highcharts.js"></script>
	<script src="https://code.highcharts.com/modules/data.js"></script>
	<script src="https://code.highcharts.com/modules/drilldown.js"></script>
</head>
<body ng-app="GoPoleis" >

	<div class="col-sm-10" ng-controller="getPlayersStatisticsController">
			
		<h1 style="margin:20px;"><u>Statistics</u></h1>
		
		<form name="form" role="form" enctype="multipart/form-data" method="post"  style="margin-top:50px; margin-left:20px;">															
			<fieldset> 		
 				<label for="game" style="margin-right:30px;">
		     		Select the game for which you want to view its players' statistics:  
				</label>
				<input type="radio" ng-model="selectGame" value="Cultural Heritages" style="margin-right:5px;" ng-change="updateGameStatistics()"><b>Cultural Heritages</b>
				<input type="radio" ng-model="selectGame" value="Cards' Packets" style="margin-right:5px; margin-left:30px;" ng-change="updateGameStatistics()"><b>Cards' Packets</b>
				<input type="radio" ng-model="selectGame" value="Paths" style="margin-right:5px; margin-left:30px;" ng-change="updateGameStatistics()"><b>Paths</b>			
 				<input type="radio" ng-model="selectGame" value="Reviews" style="margin-right:5px; margin-left:30px;" ng-change="updateGameStatistics()"><b>Reviews</b>
				<input type="radio" ng-model="selectGame" value="Medals" style="margin-right:5px; margin-left:30px;" ng-change="updateGameStatistics()"><b>Medals</b>
				<input type="radio" ng-model="selectGame" value="Missions" style="margin-right:5px; margin-left:30px;" ng-change="updateGameStatistics()"><b>Missions</b>			
			</fieldset>
		</form>

		<div id="container" style="min-width: 310px; height: 600px; margin-left:20px; margin-top:50px;"></div>

	</div>

</body>
</html>

<script>
var app = angular.module("GoPoleis", []);
app.controller('getPlayersStatisticsController', function($scope, $http, $window, $timeout) {
	
	$scope.selectGame = null;
	
	$scope.updateGameStatistics = function(){
		
		if($scope.selectGame == 'Cultural Heritages'){
			localizedChart ("getAllCHsVisitedRegions", "getAllCHsVisitedProvinces", "getAllCHsVisitedCHs", "Total visits of Cultural Heritages");		
		}
		if($scope.selectGame == 'Cards\' Packets'){	
			localizedChart ("getAllCardsPacketsOpenRegions", "getAllCardsPacketsOpenProvinces", "getAllCardsPacketsOpenCHs", "Total open Cards\' Packets");		
		}
		
		if($scope.selectGame == 'Paths'){
			localizedChart ("getAllPathsCompletedRegions", "getAllPathsCompletedProvinces", "getAllPathsCompletedCHs", "Total completed Paths");
		}
		
		if($scope.selectGame == 'Reviews'){			
			localizedChart ("getAllReviewsWrittenRegions", "getAllReviewsWrittenProvinces", "getAllReviewsWrittenCHs", "Total written Reviews");
		}

		if($scope.selectGame == 'Medals'){			
			$http({
				method : "GET",
				url : "/getAllMedalsWonCategories"
			}).then(function mySucces(response) {
				var categoriesData = response.data;
				$http({
					method : "GET",
					url : "/getAllMedalsWonMedals"
				}).then(function mySucces(response) {
					var medalsData = response.data;
					
					var title = $scope.selectGame;
					var subtitle = "Click on the histogram for a more detailed view, if available.";
					var yAxis = "Total Medals won";			
					var series = [{
					     name: 'Categories',
					     colorByPoint: false,
					     data: categoriesData
					 }];
					var drilldown=[];
					var serie = {};
					
					if(medalsData.length > 0){
						var actualCategory = medalsData[0].drilldown;
						var data = [];
						var medalData = {};
						for(var i=0; i < medalsData.length; i++){	
							if(actualCategory == medalsData[i].drilldown){
								medalData = {name:medalsData[i].name, y:medalsData[i].y, drilldown:medalsData[i].name};
								data.push(medalData);
							}
							else{
								serie = {name: "Medals", id: actualCategory, data: data};
								drilldown.push(serie);
								actualCategory = medalsData[i].drilldown;
								data = [];
								medalData = {};
								i--;
							}
						}
						var serie = {name: actualCategory, id: actualCategory, data: data};
						drilldown.push(serie);	
					}
					else{
						alert("No Medals data available!");
					}					
					createChart(title, subtitle, yAxis, series, drilldown);
					
				}, function myError(response) {
					alert("Error on the query: getAllMedalsWonMedals SELECT");
				});
			}, function myError(response) {
				alert("Error on the query: getAllMedalsWonCategories SELECT");
			});
		}
		
		
		
		
		
		
		
		
		
		
		
		
		
		
		
		
		

		if($scope.selectGame == 'Missions'){			
			alert("Missions non ancora implementato!!");
			
			
			/*series: [{
			     name: 'Regions',
			     colorByPoint: true,
			     data: [{
			         name: 'Chiara',
			         y: 56.33,
			         drilldown: 'Chiara'
			     }]
			 }],
			 drilldown: {
			     series: [{
			         name: 'Chiara',
			         id: 'Chiara',
			         data: [{name:'v11.0',y:24.13},{name:'v8.0',y:17.2, drilldown:'Seri'}],
			     },{
			         name: 'Seri',
			         id: 'Seri',
			         data: [{name:'chiara',y:21},{name:'seri',y:1}],
			     }]
			 }*/

		}
		
		
		
		
		
		
		
		
		
		
		
		
		
		
		
		
		function localizedChart (regions, provinces, chs, asseY){
			$http({
				method : "GET",
				url : "/"+regions
			}).then(function mySucces(response) {
				var regionsData = response.data;
				$http({
					method : "GET",
					url : "/"+provinces
				}).then(function mySucces(response) {
					var provincesData = response.data;
					$http({
						method : "GET",
						url : "/"+chs
					}).then(function mySucces(response) {
						var chsData = response.data;
						var title = $scope.selectGame;
						var subtitle = "Click on the histogram for a more detailed view, if available.";
						var yAxis = asseY;			
						var series = [{
						     name: 'Regions',
						     colorByPoint: false,
						     data: regionsData
						 }];
						var drilldown=[];
						var serie = {};
				
						if(provincesData.length > 0){
							var actualRegion = provincesData[0].drilldown;
							var data = [];
							var provinceData = {};
				
							for(var i=0; i < provincesData.length; i++){	
								if(actualRegion == provincesData[i].drilldown){
									provinceData = {name:provincesData[i].name, y:provincesData[i].y, drilldown:provincesData[i].name};
									data.push(provinceData);
								}
								else{
									serie = {name: "Provinces", id: actualRegion, data: data};
									drilldown.push(serie);
									actualRegion = provincesData[i].drilldown;
									data = [];
									provinceData = {};
									i--;
								}
							}
							var serie = {name: actualRegion, id: actualRegion, data: data};
							drilldown.push(serie);	
		
							if(chsData.length > 0){
								var actualProvince = chsData[0].drilldown;
								var data = [];
								var chData = {};
								
								for(var j=0; j < chsData.length; j++){	
									if(actualProvince == chsData[j].drilldown){								
										chData = {name:chsData[j].name, y:chsData[j].y};
										data.push(chData);										
									}
									else{
										serie = {name: actualProvince, id: actualProvince, data: data};
										drilldown.push(serie);
										actualProvince = chsData[j].drilldown;
										data = [];
										chData = {};
										j--;
									}
								}
								serie = {name: actualProvince, id: actualProvince, data: data};
								drilldown.push(serie);
							}
							else{
								alert("No Cultural Heritages data available!");
							}
						}
						else{
							alert("No Provinces data available!");
						}					
						createChart(title, subtitle, yAxis, series, drilldown);
					}, function myError(response) {
						alert("Error on the query: "+chs+" SELECT");
					});
				}, function myError(response) {
					alert("Error on the query: "+provinces+" SELECT");
				});
			}, function myError(response) {
				alert("Error on the query: "+regions+" SELECT");
			});
		}
	}
	
	function createChart(title, subtitle, yAxis, series, drilldown){
		//Create the chart
		var chart =	Highcharts.chart('container', {
			 chart: {
			     type: 'column'
			 },
			 title: {
			     text:  title
			 },
			 subtitle: {
			     text: subtitle
			 },
			 xAxis: {
			     type: 'category'
			 },
			 yAxis: {
			     title: {
			         text: yAxis
			     }
			 },
			 legend: {
			     enabled: false
			 },
			 credits: {
			     enabled: false
			 },
			 plotOptions: {
			     series: {
			         borderWidth: 0,
			         dataLabels: {
			             enabled: true,
			             format: '{point.y}'
			         },
			     }
			 },
			
			 tooltip: {
			     headerFormat: '<span style="font-size:11px">{series.name}</span><br>',
			     pointFormat: '<span style="color:{point.color}">{point.name}</span>: <b>{point.y} </b><br/>'
			 },
			
			 series: series,
			 drilldown: {
			     series: drilldown
			 }
		});
	}

});
</script>