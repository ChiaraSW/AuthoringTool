<!DOCTYPE html>
<html>
<head>
<meta charset="ISO-8859-1">

	<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
	<script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.4.8/angular.min.js"></script>
	<script type="text/javascript" src="http://maps.googleapis.com/maps/api/js?key=AIzaSyCrHxpT62yPIguYjilGuX_pGkOqQYvS-NQ&sensor=false"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.0.0-beta1/jquery.min.js" type="text/javascript"></script>
	
	<link data-require="bootstrap-css@3.1.1" data-semver="3.1.1" rel="stylesheet" href="//netdna.bootstrapcdn.com/bootstrap/3.1.1/css/bootstrap.min.css" />
    <script>document.write('<base href="' + document.location + '" />');</script>
    <script data-require="google-maps@*" data-semver="1.0.0" src="http://maps.google.com/maps/api/js?sensor=false"></script>
    <script type="text/javascript" src="http://maps.googleapis.com/maps/api/js?key=AIzaSyCrHxpT62yPIguYjilGuX_pGkOqQYvS-NQ&sensor=false"></script>
    <script data-require="jquery@*" data-semver="2.1.1" src="//cdnjs.cloudflare.com/ajax/libs/jquery/2.1.1/jquery.min.js"></script>
    <script data-require="angular.js@1.2.x" src="https://code.angularjs.org/1.2.22/angular.js" data-semver="1.2.22"></script>
    <script data-require="angular-route@*" data-semver="1.2.14" src="http://code.angularjs.org/1.2.14/angular-route.js"></script>
    <script data-require="angular-resource@*" data-semver="1.2.14" src="http://code.angularjs.org/1.2.14/angular-resource.js"></script>
    <script data-require="angular-bootstrap@0.11.0" data-semver="0.11.0" src="http://angular-ui.github.io/bootstrap/ui-bootstrap-tpls-0.11.0.js"></script>
    <script data-require="bootstrap@*" data-semver="3.1.1" src="//netdna.bootstrapcdn.com/bootstrap/3.1.1/js/bootstrap.min.js"></script>
	<script type="text/javascript" src="ng-map/ng-map.min.js"></script>
    <script src="https://rawgit.com/allenhwkim/angularjs-google-maps/master/build/scripts/ng-map.debug.js"></script>
    
    <script type="text/javascript" src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCrHxpT62yPIguYjilGuX_pGkOqQYvS-NQ&libraries=drawing"></script>
    
</head>
<body  ng-app="GoPoleis">

	<div class="col-sm-11" ng-controller="DrawPolygonController"> 

		
		<label for="title1" style="margin-top:30px; margin-left:20px;"> Click on the map to draw a validity area. You can select the most appropriate shape in the top-right menu on the map. </label>

	
	    <div id="panel" style="width: 200px; float: right; margin-top: 45px;">
<!--  	    	<div>
				<button id="add-button" type="submit" name="addShape" class="btn btn-success" style="width:220px;" ng-click="addShape()">Add a new shape</button>
	     	</div> -->
	    	<div>
				<button id="delBtn" type="submit" name="delShape" class="btn btn-danger" style="width:220px; margin-top: 10px;">Delete selected area</button>
	     	</div>
	        <div>
	        	<button id="getCoordinatesBtn" type="submit" name="getCoordinates" class="btn btn-info" style="width:220px; margin-top: 10px;">Get selected area's coodinates</button>
	        </div>
	        <div>
	            <textarea id="coordinatesList" class="form-control" ng-model="coordinatesList" style="resize:none; margin-top: 20px; width: 220px; height: 500px;" ng-change="updateArea()"></textarea>
	        </div>
	        <div>
	        	<button id="updateVerticesBtn" type="submit" name="updateVertices" class="btn btn-info" style="width:220px; margin-top: 10px;" ng-show="cooChanged" ng-click="updateVertices()">Update area</button>
	        </div>
	        <div>
	        	<button id="confirmBtn" type="submit" name="confirmArea" class="btn btn-primary" style="width:220px; margin-top: 20px;">Confirm validity area</button>
	        </div>
	    </div>    
	    
	    <div id="map" style="width: 1170px; height: 780px;  margin-left:20px;"></div> 
	</div>
	
</body>
</html>

<script>

var app = angular.module('GoPoleis', ['ui.bootstrap','ngMap']);
app.controller('DrawPolygonController', function($scope, $http, $window, $timeout, $modal, $rootScope) {
	
	var drawingManager;
	var selectedShape;
	var polygons = [];
	var polygon ={};
	var id=-1;
	$scope.cooChanged=false;

	function clearSelection() {
		
		if (selectedShape) {
			selectedShape.setEditable(false);
			
			//selectedShape.setMap(null);
		}
	}

    function setSelection(shape) {
    	
    	/*if(shape.type == "circle"){   		
    		google.maps.event.addListener(shape, "center_changed", getCoordinates); //o dragend
    		google.maps.event.addListener(shape, "radius_changed", getCoordinates);
		}
    	if(selectedShape.type == "polygon"){
    		google.maps.event.addListener(shape.getPath(), "insert_at", getCoordinates);
    		google.maps.event.addListener(shape.getPath(), "set_at", getCoordinates);
    	}*/
		
		
        clearSelection();
        selectedShape = shape;
        shape.setEditable(true);
        
        
        
        
        
        
        coo = "";
        for (var i = 0; i < shape.getPath().getLength(); i++) {
	        coo += shape.getPath().getAt(i).toUrlValue(5) + "\n";
	    }
        polygon = {id:id, coordinates: coo};
        polygons.push(polygon);
        //alert(shape.type);
        
        
        
        
        
        selectColor(shape.get('fillColor') || shape.get('strokeColor'));      
    }    

    function deleteSelectedShape() {
        if (selectedShape) {
        	alert("delete shape"+selectedShape.id);
            selectedShape.setMap(null);
            document.getElementById('coordinatesList').innerHTML = "";
        }
        else{
        	alert("You should select an Area.");
        }
        selectedShape=null;
    }
    
    function getCoordinates() {   
		if (selectedShape) {
			if(selectedShape.type == "circle"){
				var coordinates = "Center: "+selectedShape.getCenter().toUrlValue(5)+"\nRadius: "+selectedShape.getRadius().toPrecision(8);
				document.getElementById('coordinatesList').innerHTML = coordinates;
			}
			if(selectedShape.type == "polygon"){
				var coordinates = "";
			    for (var i = 0; i < selectedShape.getPath().getLength(); i++) {
			        coordinates += selectedShape.getPath().getAt(i).toUrlValue(5) + "\n";
			    }
			    document.getElementById('coordinatesList').innerHTML = coordinates;
			}
		}
		else{
			alert("You should select an Area.");
		}		
    }  

    function initialize() {
  	
        var map = new google.maps.Map(document.getElementById('map'), {
            zoom: 17,
            center: new google.maps.LatLng(41.890995, 12.503659),
            mapTypeId: google.maps.MapTypeId.ROADMAP,
            zoomControl: true
        });

		var circleOptions = {
			strokeColor: '#009933',
			strokeOpacity: 0.8,
			strokeWeight: 2,
			fillColor: '#009933',
			fillOpacity: 0.35,
			draggable: true,
			editable: true
		};
        
		var polyOptions = {
			strokeColor: '#009933',
			strokeOpacity: 0.8,
			strokeWeight: 2,
			fillColor: '#009933',
			fillOpacity: 0.35,  
			draggable: true,
			editable: true
		};
        
		// Creates a drawing manager attached to the map that allows the user to draw markers, lines, and shapes.
		drawingManager = new google.maps.drawing.DrawingManager({
			drawingMode: google.maps.drawing.OverlayType.POLYGON,
			drawingControlOptions: {
				position: google.maps.ControlPosition.TOP_RIGHT,
				drawingModes: [		
					google.maps.drawing.OverlayType.CIRCLE,
					//google.maps.drawing.OverlayType.RECTANGLE,
					google.maps.drawing.OverlayType.POLYGON
				]
			},
			markerOptions: {
				draggable: true
			},
			polylineOptions: {
				editable: true
			},		
			circleOptions: circleOptions,
			polygonOptions: polyOptions,
			map: map
		});
		
		google.maps.event.addListener(drawingManager, 'overlaycomplete', function (e) {    
			drawingManager.setDrawingMode(null);	
			
			// Add an event listener that selects the newly-drawn shape when the user mouses down on it.
			if (e.type != google.maps.drawing.OverlayType.MARKER) {
				// Switch back to non-drawing mode after drawing a shape.
				var newShape = e.overlay;			
				newShape.type = e.type;
				id++;
				newShape.id=id;
				newShape.vertices=e.overlay.getPath().getArray();
				google.maps.event.addListener(newShape, 'click', function () {
			        setSelection(newShape);
				});
				setSelection(newShape);			
			}
		});
        
		
		
        // Clear the current selection when the drawing mode is changed, or when the map is clicked.
        google.maps.event.addListener(drawingManager, 'drawingmode_changed', clearSelection);       
        //google.maps.event.addListener(map, 'click', clearSelection);
		google.maps.event.addListener(map, 'click', getCoordinates);
        
        
        
        
        google.maps.event.addDomListener(document.getElementById('delBtn'), 'click', deleteSelectedShape);
        google.maps.event.addDomListener(document.getElementById('getCoordinatesBtn'), 'click', getCoordinates);
        
        
        
        var bermudaTriangle;
        var squareCoords; 
        var triangleCoords;
        
        /*google.maps.event.addDomListener(document.getElementById('confirmBtn'), 'click', inserisciPolygon);
        function inserisciPolygon() {   		
        	triangleCoords = [
                new google.maps.LatLng(41.891326, 12.503450),
                new google.maps.LatLng(41.890735, 12.502790),
                new google.maps.LatLng(41.890567, 12.503970)
            ];
        	
        	squareCoords = [
                new google.maps.LatLng(41.891326, 12.503450),
                new google.maps.LatLng(41.890735, 12.502790),
                new google.maps.LatLng(41.890567, 12.503970),
                new google.maps.LatLng(41.890432, 12.503432)
            ];
        	
            bermudaTriangle = new google.maps.Polygon({
                paths: triangleCoords,
                draggable: true,
                editable: true,
                strokeColor: '#FF0000',
                strokeOpacity: 0.8,
                strokeWeight: 2,
                fillColor: '#FF0000',
                fillOpacity: 0.35
            });
            bermudaTriangle.setMap(map);
    	}
        
		$scope.updateArea = function(){
        	$scope.cooChanged=true;
		}	
		
		$scope.updateVertices = function(){
        	var newVertices = $scope.coordinatesList.split("\n");
        	var newShape = [];
        	for(var i = 0; i < newVertices.length; i++){
        		var latlong = newVertices[i].split(",");
        		var position = new google.maps.LatLng(latlong[0],latlong[1]);
        		newShape.push(position);
        	}
        	bermudaTriangle.setPath(newShape);
		}	*/
        
      
    }
    google.maps.event.addDomListener(window, 'load', initialize);

});  	
</script>