<!DOCTYPE html>
<html>
<head>
	<meta charset="ISO-8859-1">
	<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
	<script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.4.8/angular.min.js"></script>
	<script type="text/javascript" src="http://maps.googleapis.com/maps/api/js?key=AIzaSyCrHxpT62yPIguYjilGuX_pGkOqQYvS-NQ&sensor=false"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.0.0-beta1/jquery.min.js" type="text/javascript"></script>
	
	<link data-require="bootstrap-css@3.1.1" data-semver="3.1.1" rel="stylesheet" href="//netdna.bootstrapcdn.com/bootstrap/3.1.1/css/bootstrap.min.css" />
    <script>document.write('<base href="' + document.location + '" />');</script>
    <script data-require="jquery@*" data-semver="2.1.1" src="//cdnjs.cloudflare.com/ajax/libs/jquery/2.1.1/jquery.min.js"></script>
    <script data-require="angular.js@1.2.x" src="https://code.angularjs.org/1.2.22/angular.js" data-semver="1.2.22"></script>
    <script data-require="angular-route@*" data-semver="1.2.14" src="http://code.angularjs.org/1.2.14/angular-route.js"></script>
    <script data-require="angular-resource@*" data-semver="1.2.14" src="http://code.angularjs.org/1.2.14/angular-resource.js"></script>
    <script data-require="angular-bootstrap@0.11.0" data-semver="0.11.0" src="http://angular-ui.github.io/bootstrap/ui-bootstrap-tpls-0.11.0.js"></script>
    <script data-require="bootstrap@*" data-semver="3.1.1" src="//netdna.bootstrapcdn.com/bootstrap/3.1.1/js/bootstrap.min.js"></script>
    
	<script src="https://rawgit.com/allenhwkim/angularjs-google-maps/master/build/scripts/ng-map.debug.js"></script>
    <script type="text/javascript" src="ng-map/ng-map.min.js"></script> 
    
</head>
<body ng-app="GoPoleis" >

			<script type="text/ng-template" id="Stagemap.html">
				<p ng-model="heigth"></p>
				<p ng-model="readonly"></p>
				<p ng-model="required"></p>
        		<div class="modal-content" style="margin-left: -300px; height: {{heigth}}; margin-top: -20px; width: 1200px;">		
					<div class="modal-body">

						<fieldset ng-show="AddStageTitle"> 	
		     				<label for="string1" style="display: inline-block;">
		     					Right-click to add a new Stage.  
							</label>
						</fieldset>

						<fieldset ng-show="UpdStageTitle"> 	
		     				<label for="string2" style="display: inline-block;">
		     					Drag the marker to update its coordinates.  
							</label>
						</fieldset>

						<fieldset ng-show="DuplicateStageTitle"> 	
		     				<label for="string3" style="display: inline-block;">
		     					Select a Cultural Heritage and a path where to copy this stage.  
							</label>
						</fieldset>

						<map ng-show="addMap" style="display: block; height: 385px; zoom="8" center="[41.902650, 12.496022]" on-click="click()"></map>

						<map ng-show="updMap" style="display: block; height: 385px; zoom="8" center="[41.902650, 12.496022]" on-click="click()"></map>

						<form name="form" role="form">

							<div class="form-group" ng-class="{ 'has-error': form.title.$dirty && form.title.$error.required }" >
								<fieldset style="margin-top:15px;"> 	
		     						<label for="title" style="display: inline-block; vertical-align: bottom;">
		     							Title: 
									</label>
									<input type="text" class="form-control" ng-model="title" style="width:1120px; display: inline-block;" ng-readonly="readonly" required>
								</fieldset>
							</div>

							<div class="form-group" ng-class="{ 'has-error': form.curiosity.$dirty && form.curiosity.$error.required }" >
								<fieldset style="margin-top:10px;"> 	
		     						<label for="curiosity" style="display: inline-block; vertical-align: bottom;">
		     							Curiosity: 
									</label>
									<input type="text" class="form-control" ng-model="curiosity" style="width:1088px; display: inline-block;" ng-readonly="readonly" required>
								</fieldset>
							</div>

							<div class="form-group" ng-class="{ 'has-error': form.question.$dirty && form.question.$error.required }" >
		     					<fieldset style="margin-top:10px;"> 	
			     					<label for="question" style="display: inline-block; vertical-align: top;">
			     						Question:  
									</label>
									<textarea class="form-control" ng-model="question" style="resize:none; display:inline-block; width:1086px;" ng-readonly="readonly" required></textarea>
								</fieldset>
							</div>

							<div class="form-group" ng-class="{ 'has-error': form.hintonsite.$dirty && form.hintonsite.$error.required }" >
		     					<fieldset style="margin-top:10px; "> 	
			     					<label for="hintonsite" style="display: inline-block; vertical-align: bottom;">
			    				 		Hint on site: 
									</label>
									<input type="text" class="form-control" ng-model="hintonsite" style="width:1070px; display: inline-block;" ng-readonly="readonly"  required>
								</fieldset>
							</div>	

							<div class="form-group" ng-class="{ 'has-error': form.hintbypaying.$dirty && form.hintbypaying.$error.required }" >
		     					<fieldset style="margin-top:10px; "> 	
			     					<label for="hintbypaying" style="display: inline-block; vertical-align: bottom;">
			     						Hint by paying: 
									</label>
									<input type="text" class="form-control" ng-model="hintbypaying" style="width:1052px; display: inline-block;" ng-readonly="readonly" required>
								</fieldset>
							</div>	
			
							<div class="form-group" ng-class="{ 'has-error': form.answer.$dirty && form.answer.$error.required }" >
		  					   	<fieldset style="margin-top:10px;"> 	
							     	<label for="answer" style="display: inline-block; vertical-align: bottom;">
							     		Correct answer: 
									</label>
									<input type="text" class="form-control" ng-model="answer" style="width:1042px; display: inline-block;" ng-readonly="readonly" required>
								</fieldset>
							</div>

							<div class="form-group" ng-show="chpathShow">
								<label for="ch" style="display: inline-block;">
			     					Cultural Heritage:  
								</label>
								<select class="form-control" ng-model="ch" name="ch" ng-options="option as option.name for option in chs" ng-change="chSelected(ch)" style="width:200px; display: inline-block;" 
										ng-required='required'></select>	
								<label for="path" style="display: inline-block; margin-left:20px;" >
			     					Path:  
								</label>
								<select class="form-control" ng-model="path" name="path" ng-options="option as option.title for option in paths" style="width:200px; display: inline-block;" ng-required='required'></select>	
							</div>


							<div class="form-group" ng-class="{ 'has-error': form.latitude.$dirty && form.latitude.$error.required && form.longitude.$dirty && form.longitude.$error.required }" >
								<fieldset style="margin-top:10px;"> 	
		     						<label for="latitude" style="display: inline-block; vertical-align: bottom;">
		     							Latitude: 
									</label>
									<input type="text" class="form-control" id="latitude" ng-model="latitude" style="width:100px; display: inline-block;" ng-readonly="true" disabled required>
									<label for="longitude" style="display: inline-block; margin-left:20px; vertical-align: bottom;">
		     							Longitude: 
									</label>
									<input type="text" class="form-control" id="longitude"ng-model="longitude" style="width:100px; display: inline-block;" ng-readonly="true" disabled required>

									<button class="btn btn-secondary pull-right" ng-click="cancel()" style="width:100px; margin-left:10px; display: inline-block;">Cancel</button>
									<button type="submit" class="btn btn-primary pull-right" ng-disabled="form.$invalid" ng-show="CreateBtn" ng-click="executeAddStage(title, curiosity, question, hintonsite, hintbypaying, answer)" style="width:100px;">Create</button>
									<button type="submit" class="btn btn-primary pull-right" ng-disabled="form.$invalid" ng-show="UpdateBtn" ng-click="executeUpdStage(title, curiosity, question, hintonsite, hintbypaying, answer)" style="width:100px;">Update</button>
									<button type="submit" class="btn btn-primary pull-right" ng-disabled="form.$invalid" ng-show="DuplicateBtn" ng-click="executeDuplicateStage(title, curiosity, question, hintonsite, hintbypaying, answer)" style="width:100px;">Copy</button>

								</fieldset>
							</div>
							
						</form>

					</div>
				</div> 
			</script>

	<div class="col-sm-9" ng-controller="updPathController">
			
		<h1 style="margin:20px;"><u>Update Path</u>: [{{updPath.title}}]</h1><br><br>          
		
		<form name="form" role="form">     
       
       		<div class="form-group" ng-class="{ 'has-error': form.title.$dirty && form.title.$error.required }" >
		     	<fieldset style="margin-top:30px; margin-left:20px;"> 	
			     	<label for="title" style="display: inline-block; vertical-align: bottom;">
			     		Title: 
					</label>
					<input type="text" class="form-control" ng-model="updPath.title" style="width:1080px; display: inline-block;" required>
				</fieldset>
			</div>	
				
	     	<div class="form-group" ng-class="{ 'has-error': form.finalquestion.$dirty && form.finalquestion.$error.required }" >
		     	<fieldset style="margin-top:30px; margin-left:20px;"> 	
			     	<label for="finalquestion" style="display: inline-block; vertical-align: top;">
			     		Final question:  
					</label>
					<textarea class="form-control" ng-model="updPath.finalquestion" style="resize:none; display:inline-block; width:1010px;" required></textarea>
				</fieldset>
			</div>
			
			<div class="form-group" ng-class="{ 'has-error': form.hintonsite.$dirty && form.hintonsite.$error.required }" >
		     	<fieldset style="margin-top:30px; margin-left:20px;"> 	
			     	<label for="hintonsite" style="display: inline-block; vertical-align: bottom;">
			     		Hint on site: 
					</label>
					<input type="text" class="form-control" ng-model="updPath.hintonsite" style="width:1030px; display: inline-block;" required>
				</fieldset>
			</div>	
			
			<div class="form-group" ng-class="{ 'has-error': form.hintbypaying.$dirty && form.hintbypaying.$error.required }" >
		     	<fieldset style="margin-top:30px; margin-left:20px;"> 	
			     	<label for="hintbypaying" style="display: inline-block; vertical-align: bottom;">
			     		Hint by paying: 
					</label>
					<input type="text" class="form-control" ng-model="updPath.hintbypaying" style="width:1012px; display: inline-block;" required>
				</fieldset>
			</div>	
			
			<div class="form-group" ng-class="{ 'has-error': form.answer.$dirty && form.answer.$error.required }" >
		     	<fieldset style="margin-top:30px; margin-left:20px;"> 	
			     	<label for="answer" style="display: inline-block; vertical-align: bottom;">
			     		Correct answer: 
					</label>
					<input type="text" class="form-control" ng-model="updPath.answer" style="width:1001px; display: inline-block;" required>
				</fieldset>
			</div>
			
			<div>
	        	<iframe id="mapFrame"  src="Game3_StagesMap.html" style="height:360px; width: 1500px; border: none;"></iframe>
	        </div>
			
			<fieldset style="margin-top:10px; margin-left:20px;"> 	 	
				<label for="search" style="display: inline-block; vertical-align: bottom;" >
		        	<span class="glyphicon glyphicon-search"></span>
		        	Search: 
		        </label>
	      		<input type="text" ng-model="searchStages.info" class="form-control" style="width:250px; display: inline-block; vertical-align: bottom;"/>
	      		<label for="string1" style="display: inline-block; vertical-align: bottom; margin-left:20px;">
		     		Right-click on the map to add a new stage: 
				</label>
			</fieldset>
			
			<fieldset style="margin-top:30px; margin-left:20px;""> 	
				<ul style="list-item-style:circle; margin-left:20px; padding-left:0px;">
		       		<li ng-repeat="stage in stages | filter:searchStages" ng-model="getPathStages.selection" ng-value="stage.title" id="{{stage.title}}">	        	
		        		<h4 stage.name="selection">     			
		        			<span class="glyphicon glyphicon-map-marker" ng-click="localizeStage(stage.code)"></span> 
		        			<span class="glyphicon glyphicon-pencil" ng-click="updStageModal(stage.code)"></span> 
 		        			<span class="glyphicon glyphicon-duplicate" ng-click="duplicateStageModal(stage.code)"></span>
		        			<span class="glyphicon glyphicon-trash" ng-click="delStage(stage.code)"></span> 
		        			{{ stage.title }}
		        		</h4>	
		       		</li>
		        </ul>
			</fieldset>
			

			<div class="form-actions" style="margin-top:60px; margin-bottom:30px; margin-left:200px;">
	            <button type="submit" name="btnUpdPath" ng-disabled="form.$invalid || vm.dataLoading" class="btn btn-info" ng-click="executeUpdPath()">Update</button>
	            <img ng-if="vm.dataLoading"/>
	            <a href="Game3_Paths.html" target="_self">Cancel</a>
	        </div>		
 
	    </form>

	</div>
	
</body>
</html>
<script>
var sCode=null;
	var app = angular.module("GoPoleis", ['ui.bootstrap','ngMap']);
	app.controller('updPathController', function($scope, $http, $window, $timeout, $modal, $rootScope) {

		$scope.updPath={};
		var pathCode = parent.window.getPathCode();
		var questionCode;
		var chCode;

		var map = new google.maps.Map(document.getElementById("mapFrame"));
					
		$http({
			method : "GET",
			url : "/getPath/"+pathCode
		}).then(function mySucces(response) {
			var path  = response.data;	
			$scope.updPath.title = path[0].title;
			$scope.updPath.finalquestion = path[0].question;
			$scope.updPath.hintonsite = path[0].hintonsite;
			$scope.updPath.hintbypaying = path[0].hintbypaying;
			$scope.updPath.answer = path[0].answer;
			questionCode=path[0].questionCode;
			chCode = path[0].heritage;
		}, function myError(response) {
			alert("Error on the query: getPath SELECT");
		});
		
		$http({
			method : "GET",
			url : "/getPathStages/"+pathCode
		}).then(function mySucces(response) {		
			var stages  = response.data;	
			$scope.stages = [];
			if (stages.length > 0){
				$timeout(function() {
					$scope.stages  = stages;	
			    }, 10);
			}
		}, function myError(response) {
			alert("Error on the query: getPathStages SELECT");
		});
		
		$rootScope.$on('mapsInitialized', function(evt, maps){		
	    	$scope.mapAdd = maps[0];
	    	$scope.mapUpd = maps[1];
	    });
		
		$window.getCode = function (){
			return chCode;
		};
		
		$window.getPathCode = function (){
			return pathCode;
		};
		
		$window.getStageLocation = function (){
			return sCode;
		};
		
		$scope.localizeStage = function (stageCode) {	
			sCode = stageCode;
			document.getElementById('mapFrame').src = "Game3_StagesMap.html";
		};

		$window.addStage = function(centerLat, centerLng, centerZoom) {   	
			//pCode=pathCode;
			$scope.addStageModal(centerLat, centerLng, centerZoom);
	   	};
	   	
	   	$scope.addStageModal = function (centerLat, centerLng, centerZoom) {
	   		var modalInstance = $modal.open({
	    		templateUrl : 'Stagemap.html',
	    		controller : 'addStageCtrl'
	    	});
	    	modalInstance.result.then(function() {
	    	}, function() {
	    	});
	    	
	    	$timeout(function() {
	    		google.maps.event.trigger($scope.mapAdd, 'resize');
	    		$scope.mapAdd.setCenter(new google.maps.LatLng(centerLat,centerLng));
	    		$scope.mapAdd.setZoom(parseInt(centerZoom));    
	    	}, 500);
		};

		$scope.updStageModal = function (stageCode) {	
			sCode = stageCode;
			var result;
			$http({			 
				method : "GET",
				url : "/getStage/"+stageCode
				}).then(function mySucces(response) {
					result  = response.data;
				}, function myError(response) {
					result  = response.statusText;
			});
			
			var modalInstance = $modal.open({
	    		templateUrl : 'Stagemap.html',
	    		controller : 'updStageCtrl'
	    	});
	    	modalInstance.result.then(function() {
	    	}, function() {
	    	});
	    	
	    	$timeout(function() {
	    		google.maps.event.trigger($scope.mapUpd, 'resize');
	    		$scope.mapUpd.setCenter(new google.maps.LatLng(result[0].latitude,result[0].longitude));
	    		$scope.mapUpd.setZoom(16);    		 	
	    	}, 500);
		};
		
		$scope.duplicateStageModal = function (stageCode) {	
			sCode = stageCode;
			var modalInstance = $modal.open({
	    		templateUrl : 'Stagemap.html',
	    		controller : 'duplicateStageCtrl'
	    	});
	    	modalInstance.result.then(function() {
	    	}, function() {
	    	});    	
		};
		
		$scope.executeUpdPath = function(){				
			//Query: UPDATE Question on DB
			$http({
				method: 'GET',
				url: '/updQuestion/'+$scope.updPath.finalquestion+'/'+$scope.updPath.hintonsite+'/'+$scope.updPath.hintbypaying+'/'+$scope.updPath.answer+'/'+questionCode
			}).then(function successCallback(response) {	
				
				//Query: UPDATE Path on DB
				$http({
					method: 'GET',
					url: '/updPath/'+$scope.updPath.title+'/'+questionCode+'/false/'+chCode+'/'+pathCode				//sistema enabled!!!
				}).then(function successCallback(response) {	
					window.open("Game3_Paths.html", "_self");   
				}, function errorCallback(response) {
					alert("Error on the query: Path UPDATE");
				});
				
			}, function errorCallback(response) {
				alert("Error on the query: Question UPDATE");
			});

		}
		
		$scope.delStage = function (stageCode) {
        	if ($window.confirm("Are you sure you want to delete this Stage?")) {
 				$http({
 					method : "GET",
 					url : "/delStage/"+stageCode
				}).then(function mySucces(response) {
 					results  = response.data;	 
 					alert("Successful delete");
 					window.open("Game3_UpdPath.html", "_self"); 
 				}, function myError(response) {
 					$scope.results  = response.statusText;
 				});
			} 
		};
	});
	

	
//Pop-up per l'inserimento di un nuovo Stage	
app.controller("addStageCtrl", function($scope, $log, $modalInstance, $rootScope, $http) {

	$scope.heigth= "830px";
	var pathCode = parent.window.getPathCode();	
	var newMarker=true;
	
	$rootScope.$on('mapsInitialized', function(evt, maps){			
		
		
		var results;
		
		$scope.latitude = null;
    	$scope.longitude = null; 
    	
    	$scope.AddStageTitle=true;
    	$scope.UpdStageTitle=false;
    	$scope.DuplicateStageTitle=false;
    	$scope.CreateBtn=true;
    	$scope.UpdateBtn=false;
    	$scope.DuplicateBtn=false;
    	$scope.addMap=true;
    	$scope.updMap=false;
    	$scope.chpathShow=false;
    	$scope.readonly=false;
    	$scope.required=false;
            
    	$scope.map = maps[0];   
       
    	
    	$http({			 
			method : "GET",
			url : "/getPathStages/"	+ pathCode
			}).then(function mySucces(response) {
				results  = response.data;
				for (var i=0; i< results.length; i++){				
					var coordinates = new google.maps.LatLng(results[i].latitude,results[i].longitude);							
			        setMarker($scope.map, coordinates, "red", false);	
				}
			}, function myError(response) {
				results  = response.statusText;
		});	
    	
    	//Aggiunge un marker alla mappa e gli aggiunge un dragendListener(se marker da aggiungere)
	    function setMarker(map, coordinates, icon, draggable) {
	    	var marker = new google.maps.Marker({
	        	position: coordinates,
	        	map: map,
	        	draggable: draggable,
	        	icon: 'https://maps.google.com/mapfiles/ms/icons/'+icon+'-dot.png',
			});
	    	if (draggable){
	    		google.maps.event.addListener(marker, 'dragend', function () {
					$scope.latitude = marker.position.lat().toPrecision(8);
		        	$scope.longitude = marker.position.lng().toPrecision(8);
		        	$scope.$apply();
	    		});
	    	}	 
	    }
    	
    	$scope.map.addListener('rightclick', function(event) {    //aggiunge UN marker in base al rigthclick sulla mappa [rigthclick, dblclick, click]     	
	    	if (newMarker == true){
	    		$scope.latitude = event.latLng.lat().toPrecision(8);
	        	$scope.longitude = event.latLng.lng().toPrecision(8);
	        	$scope.$apply();
	    		newMarker = false;
	    		setMarker($scope.map, event.latLng, "green", true);  
	    	}
	    });
    	
    });

	$scope.executeAddStage = function(title, curiosity, question, hintonsite, hintbypaying, answer){	
		//Query: INSERT Coordinates on DB
		$http({
			method: 'GET',
			url:	'/addCoordinates/0/'+$scope.latitude+'/'+$scope.longitude
		}).then(function successCallback(response) {	

			var cooCode = response.data.insertId;
			
			//Query: INSERT Question on DB
			$http({
				method: 'GET',
				url: '/addQuestion/0/'+question+'/'+hintonsite+'/'+hintbypaying+'/'+answer		
			}).then(function successCallback(response) {	
				
				var questionCode = response.data.insertId;

				//Query: INSERT Stage on DB
				$http({
					method: 'GET',
					url: 	'/addStage/0/'+title+'/'+curiosity+'/'+questionCode+'/'+cooCode+'/'+pathCode					
				}).then(function successCallback(response) {	
					newMarker = true;
					window.open("Game3_UpdPath.html", "_self");   
				}, function errorCallback(response) {
					alert("Error on the query: Stage INSERT");
				});
				
			}, function errorCallback(response) {
				alert("Error on the query: Question INSERT");
			});

		}, function errorCallback(response) {
			alert("Error on the query: Coordinates INSERT");
		});
	};
	
	$scope.cancel = function() { 
		newMarker = false;
		$modalInstance.dismiss('cancel');
	};
});	
	
	
//Pop-up per l'update dello Stage selezionato		
app.controller("updStageCtrl", function($scope, $log, $modalInstance, $rootScope, $http) {
	
	$scope.heigth= "830px";
	var newMarker = true;
	var marker = null;
	var questionCode=null;
	var cooCode=null;
	var oldLat=null;
	var oldLong=null;
	
	var pathCode = parent.window.getPathCode();	
	
	$rootScope.$on('mapsInitialized', function(evt, maps){	
		var results;
    	$scope.mapUpd = maps[1];
    	
    	$scope.AddStageTitle=false;
    	$scope.UpdStageTitle=true;
    	$scope.DuplicateStageTitle=false;
    	$scope.CreateBtn=false;
    	$scope.UpdateBtn=true;
    	$scope.DuplicateBtn=false;
    	$scope.addMap=false;
    	$scope.updMap=true;
    	$scope.chpathShow=false;
    	$scope.readonly=false;
    	$scope.required=false;
    	
    	$http({			 
			method : "GET",
			url : "/getPathStages/"+pathCode		
			}).then(function mySucces(response) {
				results  = response.data;

				for (var i=0; i< results.length; i++){				
					var coordinates = new google.maps.LatLng( results[i].latitude,  results[i].longitude);			
					if (results[i].code != sCode){
						setMarker($scope.mapUpd, coordinates, "red", false);
					} 	
				}					
				$http({			 
					method : "GET",
					url : "/getStage/"+sCode		
					}).then(function mySucces(response) {
						results  = response.data;
						var coordinates = new google.maps.LatLng( results[0].latitude,  results[0].longitude);	
						cooCode = results[0].cooCode;
						$scope.latitude = results[0].latitude;
						oldLat=$scope.latitude;
				    	$scope.longitude = results[0].longitude;    
				    	oldLong=$scope.longitude;
				    	$scope.title = results[0].title; 
				    	$scope.curiosity = results[0].curiosity; 
				    	questionCode=results[0].questionCode;
				    	$scope.question = results[0].question; 
				    	$scope.hintonsite = results[0].hintonsite; 
				    	$scope.hintbypaying = results[0].hintbypaying; 
				    	$scope.answer = results[0].answer; 
				    	
						if(newMarker){		
						    setMarker($scope.mapUpd, coordinates, "green", true);	
							newMarker = false;   		
						}
					}, function myError(response) {
						results  = response.statusText;
				});					
			}, function myError(response) {
				results  = response.statusText;
		});	

    	//Aggiunge un marker alla mappa
	    function setMarker(map, coordinates, icon, draggable) {
	    	marker = new google.maps.Marker({
	        	position: coordinates,
	        	map: map,
	        	draggable: draggable,
	        	icon: 'https://maps.google.com/mapfiles/ms/icons/'+icon+'-dot.png',
			});
	    	if (draggable){
	    		google.maps.event.addListener(marker, 'dragend', function () {
					$scope.latitude = marker.position.lat().toPrecision(8);
		        	$scope.longitude = marker.position.lng().toPrecision(8);
		        	$scope.$apply();
	    		});
	    	}
	    }  	
    	
    });

	$scope.executeUpdStage = function(title, curiosity, question, hintonsite, hintbypaying, answer){	
		
		//Query: UPDATE Question on DB
		$http({
			method: 'GET',
			url: '/updQuestion/'+question+'/'+hintonsite+'/'+hintbypaying+'/'+answer+'/'+questionCode
		}).then(function successCallback(response) {	
			
			//Query: UPDATE Coordinates on DB
			$http({
				method: 'GET',
				url:	'/updCoordinates/'+$scope.latitude+'/'+$scope.longitude+'/'+cooCode			
			}).then(function successCallback(response) {	
								
				//Query: UPDATE Stage on DB
				$http({
					method: 'GET',
					url:	'/updStage/'+title+'/'+curiosity+'/'+questionCode+'/'+cooCode+'/'+pathCode+'/'+sCode
				}).then(function successCallback(response) {	
					window.open("Game3_UpdPath.html", "_self");   
				}, function errorCallback(response) {
					alert("Error on the query: Stage UPDATE");
				});				
			
			}, function errorCallback(response) {
				alert("Error on the query: Coordinates UPDATE");
			});

		}, function errorCallback(response) {
			alert("Error on the query: Question UPDATE");
		});
					
					
	}

	$scope.cancel = function() {
		newMarker = false;
		$modalInstance.dismiss('cancel');
	};
});	

//Pop-up per il duplicate dello Stage selezionato		
app.controller("duplicateStageCtrl", function($scope, $log, $modalInstance, $rootScope, $http) {

	$scope.heigth= "530px";	
	$scope.AddStageTitle=false;
	$scope.UpdStageTitle=false;
	$scope.DuplicateStageTitle=true;
	$scope.CreateBtn=false;
	$scope.UpdateBtn=false;			
	$scope.DuplicateBtn=true;			
	$scope.addMap=false;
	$scope.updMap=false;		
	$scope.chpathShow=true;
	$scope.readonly=true;
	$scope.required=true;
	
	
			    	
	$http({
		method: 'GET',
		url:	'/getStage/'+sCode
	}).then(function successCallback(response) {	
		var stage  = response.data;
		$scope.latitude = stage[0].latitude;
    	$scope.longitude = stage[0].longitude;    
    	$scope.title = stage[0].title; 
    	$scope.curiosity = stage[0].curiosity; 
    	$scope.question = stage[0].question; 
    	$scope.hintonsite = stage[0].hintonsite; 
    	$scope.hintbypaying = stage[0].hintbypaying; 
    	$scope.answer = stage[0].answer; 

    	$http({
    		method: 'GET',
    		url:	'/getGame3CHsWithPaths/user3'
    	}).then(function successCallback(response) {	
    		$scope.chs = response.data;    		
    	}, function errorCallback(response) {
    		alert("Error on the query: getGame3CHs SELECT");
    	});					
	}, function errorCallback(response) {
		alert("Error on the query: Stage SELECT");
	});					    	
			    	
	$scope.chSelected = function(selection){
		$http({
    		method: 'GET',
    		url:	'/getCHPaths/'+selection.code
    	}).then(function successCallback(response) {	
    		$scope.paths = response.data;    		
    	}, function errorCallback(response) {
    		alert("Error on the query: getCHPaths SELECT");
    	});			
    };
    
    $scope.executeDuplicateStage = function(title, curiosity, question, hintonsite, hintbypaying, answer){	
		//Query: INSERT Coordinates on DB
		$http({
			method: 'GET',
			url:	'/addCoordinates/0/'+$scope.latitude+'/'+$scope.longitude
		}).then(function successCallback(response) {	

			var cooCode = response.data.insertId;
			
			//Query: INSERT Question on DB
			$http({
				method: 'GET',
				url: '/addQuestion/0/'+question+'/'+hintonsite+'/'+hintbypaying+'/'+answer		
			}).then(function successCallback(response) {	
				
				var questionCode = response.data.insertId;

				//Query: INSERT Stage on DB
				$http({
					method: 'GET',
					url: 	'/addStage/0/'+title+'/'+curiosity+'/'+questionCode+'/'+cooCode+'/'+getPathCode()					
				}).then(function successCallback(response) {	
					window.open("Game3_UpdPath.html", "_self");   
				}, function errorCallback(response) {
					alert("Error on the query: Stage INSERT");
				});

			}, function errorCallback(response) {
				alert("Error on the query: Question INSERT");
			});

		}, function errorCallback(response) {
			alert("Error on the query: Coordinates INSERT");
		});
    
		getPathCode = function(){
			var pCode;
			for (var i=0; i<$scope.paths.length; i++) {
				if($scope.paths[i].name == $scope.path){
					pCode = $scope.paths[i].code;
				}
			}
			return pCode;
		}
	};
    
    $scope.cancel = function() {
		newMarker = false;
		$modalInstance.dismiss('cancel');
	};
});	
</script>